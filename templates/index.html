<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PCB Quote (Internal)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="/lt.png">
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
<header><h1>PCB Quotation — Internal</h1></header>

<div class="page-layout">
  <div class="page-main">
    {% if error_msgs and error_msgs|length %}
    <div class="alert">
      <ul>
        {% for m in error_msgs %}<li>{{ m }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}

    <form id="quote-form" method="post" novalidate data-default-material="{{ defaults.material|e }}" data-default-finish="{{ defaults.finish|e }}">
      <section>
        <h2>Board Basics</h2>
        <div class="grid">
          <label>Width (mm)
            <input name="width" type="number" step="1" value="{{ values.width }}">
          </label>
          <label>Height (mm)
            <input name="height" type="number" step="1" value="{{ values.height }}">
          </label>
          <label>开料件数
            <input name="panel_boards" type="number" step="1" value="{{ values.panel_boards }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Materials</h2>
        <div class="grid">
          <label>Material
            <select name="material" id="material-select">
              {% for m in material_options %}
              <option value="{{ m }}" {% if values.material==m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="material-price-field">
            <span id="material-price-label">{{ (values.material or defaults.material) }}</span>
            <input name="material_price" id="material-price-input" type="number" step="1" value="{{ material_price_value }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Treatment</h2>
        <div class="grid">
          <label>Layers
            <input name="layers" type="number" step="1" value="{{ values.layers }}">
          </label>
          <label>表面处理
            <select name="finish" id="finish-select">
              {% for f in finish_options %}
              <option value="{{ f }}" {% if values.finish==f %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="finish-price-field">
            <span id="finish-price-label">{{ (values.finish or defaults.finish) }}</span>
            <input name="finish_price" id="finish-price-input" type="number" step="1" value="{{ finish_price_value }}">
          </label>
          <label>线路
            <input name="etching_cost" type="number" step="1" value="{{ values.etching_cost }}">
          </label>
          <label>阻焊
            <input name="masking_cost" type="number" step="1" value="{{ values.masking_cost }}">
          </label>
          <label>文字丝印
            <input name="silkscreen_cost" type="number" step="1" value="{{ values.silkscreen_cost }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Process</h2>
        <div class="grid">
          <label>直 PTH
            <input name="direct_pth_holes" type="number" step="1" min="0" value="{{ values.direct_pth_holes }}">
          </label>
          <label>CNC 钻孔
            <input name="cnc_pth_holes" type="number" step="1" min="0" value="{{ values.cnc_pth_holes }}">
          </label>
          <label>开料
            <input name="cutting_cost" type="number" step="1" min="0" value="{{ values.cutting_cost }}">
          </label>
          <label>锣板/冲板
            <input name="routing_cost" type="number" step="1" min="0" value="{{ values.routing_cost }}">
          </label>
          <label>E-test
            <input name="e_test_cost" type="number" step="0.1" min="0" value="{{ values.e_test_cost }}">
          </label>
          <label>V-cut
            <input name="v_cut_cost" type="number" step="0.1" min="0" value="{{ values.v_cut_cost }}">
          </label>
          <label>FQC
            <input name="fqc_cost" type="number" step="0.1" min="0" value="{{ values.fqc_cost }}">
          </label>
          <label>包裝
            <input name="package_cost" type="number" step="0.1" min="0" value="{{ values.package_cost }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Sewage</h2>
        <div class="grid">
          <label>Water
            <input name="sewage_water" type="number" step="1" value="{{ values.sewage_water }}">
          </label>
          <label>Electricity
            <input name="sewage_electricity" type="number" step="1" value="{{ values.sewage_electricity }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Others</h2>
        <div class="grid">
          <label>Overheads (%)
            <input name="overheads_pct" type="number" step="1" min="0" value="{{ params_values.overheads_pct }}">
          </label>
          <label>產出 (%)
            <input name="yield_pct" type="number" step="1" min="0" max="100" value="{{ params_values.yield_pct }}">
          </label>
          <label>利润 (%)
            <input name="margin_pct" type="number" step="1" min="0" value="{{ params_values.margin_pct }}">
          </label>
          <label>目的地
            <select name="ship_zone">
              {% for z in ship_zone_options %}
              <option value="{{ z }}" {% if values.ship_zone==z %}selected{% endif %}>{{ z }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </section>

    </form>
  </div>

  <aside class="page-summary">
    <section class="summary-card">
      <h2>Live Summary</h2>
      <div id="live-summary">
        {% if result %}
        <div class="grid">
          <div>
            <h3>Breakdown</h3>
            <ul class="mono">
              <li>Material: {{ result.breakdown.material.total }}
                <ul>
                  <li>{{ values.material or 'Laminate' }}: {{ result.breakdown.material.components.laminate }}</li>
                </ul>
              </li>
              <li>Treatment: {{ result.breakdown.treatment.total }}
                <ul>
                  <li>{{ values.finish or 'Finish' }}: {{ result.breakdown.treatment.components.finish }}</li>
                  <li>线路: {{ result.breakdown.treatment.components.etching }}</li>
                  <li>阻焊: {{ result.breakdown.treatment.components.masking }}</li>
                  <li>文字丝印: {{ result.breakdown.treatment.components.silkscreen }}</li>
                </ul>
              </li>            
              <li>Process: {{ result.breakdown.process.total }}
                <ul>
                  <li>直 PTH: {{ result.breakdown.process.components.direct_pth }}</li>
                  <li>CNC 钻孔: {{ result.breakdown.process.components.cnc_pth }}</li>
                  <li>开料: {{ result.breakdown.process.components.cutting }}</li>
                  <li>锣板/冲板: {{ result.breakdown.process.components.routing }}</li>
                  <li>E-test: {{ result.breakdown.process.components.e_test }}</li>
                  <li>V-cut: {{ result.breakdown.process.components.v_cut }}</li>
                  <li>FQC: {{ result.breakdown.process.components.fqc }}</li>
                  <li>包装: {{ result.breakdown.process.components.package }}</li>
                </ul>
              </li>
              <li>Sewage: {{ result.breakdown.sewage.total }}
                <ul>
                  <li>Water: {{ result.breakdown.sewage.components.water }}</li>
                  <li>Electricity: {{ result.breakdown.sewage.components.electricity }}</li>
                </ul>
              </li>
              <li>Others: {{ result.breakdown.others.total }}
                <ul>
                  <li>Overhead: {{ result.breakdown.others.overhead }}</li>
                  <li>產出 (%): {{ result.breakdown.others.yield_pct }}</li>
                  <li>地区: {{ result.breakdown.others.factor }}</li>
                  <li>运输: {{ result.breakdown.others.logistic }}</li>
                </ul>
              </li>
              <li>开料件数: {{ result.breakdown.boards_per_panel }}</li>
            </ul>
            <ul class="mono">
              <li>Panel Cost: {{ result.cogs }}</li>
              <li>Unit Cost: {{ result.cogs_unit }}</li>
              <li>Unit price: {{ result.price_unit }}</li>
            </ul>
          </div>
        </div>
        {% else %}
        <p class="summary-placeholder">Fill out the form to see pricing details here.</p>
        {% endif %}
      </div>
    </section>
  </aside>
</div>

<script id="material-prices-data" type="application/json">{{ material_prices|tojson }}</script>
<script id="finish-costs-data" type="application/json">{{ finish_costs|tojson }}</script>

<script>
(function () {
  const materialDataEl = document.getElementById('material-prices-data');
  const finishDataEl = document.getElementById('finish-costs-data');
  const materialPrices = materialDataEl ? JSON.parse(materialDataEl.textContent || '{}') : {};
  const finishCosts = finishDataEl ? JSON.parse(finishDataEl.textContent || '{}') : {};

  const form = document.getElementById('quote-form');
  const summary = document.getElementById('live-summary');
  if (!form || !summary) {
    return;
  }

  const defaultMaterial = form.dataset.defaultMaterial || '';
  const defaultFinish = form.dataset.defaultFinish || '';

  let controller;

  const attachPriceField = ({ selectId, inputId, labelId, defaults, fallback }) => {
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    const label = document.getElementById(labelId);
    if (!select || !input || !label) {
      return;
    }

    const updateLabelAndDefault = () => {
      const selected = select.value || fallback;
      label.textContent = selected || fallback;
      const base = defaults[selected];
      input.value = base !== undefined ? base : '';
    };

    select.addEventListener('change', () => {
      updateLabelAndDefault();
    });

    updateLabelAndDefault();
  };

  attachPriceField({
    selectId: 'material-select',
    inputId: 'material-price-input',
    labelId: 'material-price-label',
    defaults: materialPrices,
    fallback: defaultMaterial,
  });

  attachPriceField({
    selectId: 'finish-select',
    inputId: 'finish-price-input',
    labelId: 'finish-price-label',
    defaults: finishCosts,
    fallback: defaultFinish,
  });

  const submitForm = () => {
    const formData = new FormData(form);
    const payload = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      payload.append(key, value);
    }

    if (controller) {
      controller.abort();
    }
    controller = new AbortController();

    fetch(form.action || window.location.pathname, {
      method: 'POST',
      body: payload,
      headers: { 'X-Requested-With': 'fetch' },
      signal: controller.signal,
    })
      .then((response) => response.text())
      .then((htmlText) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        const newSummary = doc.getElementById('live-summary');
        if (newSummary) {
          summary.innerHTML = newSummary.innerHTML;
        }
      })
      .catch((error) => {
        if (error.name === 'AbortError') {
          return;
        }
        console.error('Failed to refresh summary', error);
      });
  };

  const debouncedSubmit = (() => {
    let timeoutId;
    return () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(submitForm, 200);
    };
  })();

  form.addEventListener('input', debouncedSubmit);
  form.addEventListener('change', debouncedSubmit);
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    submitForm();
  });

  submitForm();
})();
</script>
</body>
</html>
