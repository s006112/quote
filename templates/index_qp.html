<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PCB Quote (Internal)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="/lt.png">
<link href="{{ url_for('static', filename='qp.css') }}" rel="stylesheet">
</head>
<body>
<header><h1>PCB Quotation — Internal</h1></header>

<div class="page-layout">
  <div class="page-main">
    {% if error_msgs and error_msgs|length %}
    <div class="alert">
      <ul>
        {% for m in error_msgs %}<li>{{ m }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}

    <form id="quote-form" method="post" novalidate data-default-material="{{ defaults.material|e }}" data-default-finish="{{ defaults.finish|e }}" data-default-masking="{{ defaults.masking|e }}" data-default-plating="{{ defaults.plating|e }}">
      <section>
        <h2>Basics</h2>
        <div class="grid">
          <label>Width (mm)
            <input name="width" type="number" step="1" value="{{ values.width }}">
          </label>
          <label>Height (mm)
            <input name="height" type="number" step="1" value="{{ values.height }}">
          </label>
          <label>开料件数
            <input name="panel_boards" type="number" step="1" value="{{ values.panel_boards }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Materials</h2>
        <div class="grid">
          <label>板材
            <select name="material" id="material-select">
              {% for m in priced_options.material %}
              <option value="{{ m }}" {% if values.material==m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="material-price-field">
            <span id="material-price-label">{{ (values.material or defaults.material) }}</span>
            <input name="material_price" id="material-price-input" type="number" step="1" value="{{ material_price_value }}">
          </label>
          <label>层数
            <input name="layers" type="number" step="1" value="{{ values.layers }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Treatment</h2>
        <div class="grid">
          <label>表面处理
            <select name="finish" id="finish-select">
              {% for f in priced_options.finish %}
              <option value="{{ f }}" {% if values.finish==f %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="finish-price-field">
            <span id="finish-price-label">{{ (values.finish or defaults.finish) }}</span>
            <input name="finish_price" id="finish-price-input" type="number" step="1" value="{{ finish_price_value }}">
          </label>
          <label>阻焊
            <select name="masking" id="masking-select">
              {% for mask in priced_options.masking %}
              <option value="{{ mask }}" {% if values.masking==mask %}selected{% endif %}>{{ mask }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="masking-price-field">
            <span id="masking-price-label">{{ (values.masking or defaults.masking) }}</span>
            <input name="masking_price" id="masking-price-input" type="number" step="1" value="{{ masking_price_value }}">
          </label>
          <label>线路
            <input name="etching_cost" type="number" step="1" value="{{ values.etching_cost }}">
          </label>
          <label>文字丝印
            <input name="silkscreen_cost" type="number" step="1" value="{{ values.silkscreen_cost }}">
          </label>
        </div>
      </section>

      <section>
        <h2>CNC</h2>
        <div class="grid">
          <label>PCB厚度
            <select name="pcb_thickness" id="pcb-thickness-select">
              {% for t in pcb_thickness_options %}
              <option value="{{ t }}" {% if values.pcb_thickness==t %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </label>
          <label>孔径
            <select name="cnc_hole_dimension" id="cnc-hole-select">
              {% for d in cnc_hole_dimension_options %}
              <option value="{{ d }}" {% if values.cnc_hole_dimension==d %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </label>
          <label>每孔$$
            <input name="cnc_pth_per_hole" type="number" step="0.0001" min="0" value="{{ params_values.cnc_pth_per_hole }}">
          </label>
          <label>钻孔数
            <input name="cnc_pth_holes" type="number" step="1" min="0" value="{{ values.cnc_pth_holes }}">
          </label>
          <label>叠片数
            <input name="stack_qty" id="stack-qty-input" type="number" step="1" min="1" value="{{ values.stack_qty }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Process</h2>
        <div class="grid">
          <label>电铜
            <select name="plating" id="plating-select">
              {% for p in priced_options.plating %}
              <option value="{{ p }}" {% if values.plating==p %}selected{% endif %}>{{ p }}</option>
              {% endfor %}
            </select>
          </label>
          <label id="plating-price-field">
            <span id="plating-price-label">{{ (values.plating or defaults.plating) }}</span>
            <input name="plating_price" id="plating-price-input" type="number" step="1" value="{{ plating_price_value }}">
          </label>
          <label>开料
            <input name="cutting_cost" type="number" step="1" min="0" value="{{ values.cutting_cost }}">
          </label>
          <label>每锣寸
            <input name="routing_per_inch" type="number" step="0.0001" min="0" value="{{ params_values.routing_per_inch }}">
          </label>
          <label>锣程 (寸)
            <input name="routing_length" type="number" step="1" min="0" value="{{ values.routing_length }}">
          </label>
          <label>啤板
            <input name="stamping_cost" type="number" step="1" min="0" value="{{ values.stamping_cost }}">
          </label>
          <label>后工序
            <input name="post_process_cost" type="number" step="1" min="0" value="{{ values.post_process_cost }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Sewage</h2>
        <div class="grid">
          <label>污水
            <input name="sewage_water" type="number" step="1" value="{{ values.sewage_water }}">
          </label>
          <label>电
            <input name="sewage_electricity" type="number" step="1" value="{{ values.sewage_electricity }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Others</h2>
        <div class="grid">
          <label>Overheads (%)
            <input name="overheads_pct" type="number" step="1" min="0" value="{{ params_values.overheads_pct }}">
          </label>
          <label>產出 (%)
            <input name="yield_pct" type="number" step="1" min="0" max="100" value="{{ params_values.yield_pct }}">
          </label>
          <label>利润 (%)
            <input name="margin_pct" type="number" step="1" min="0" value="{{ params_values.margin_pct }}">
          </label>
        </div>
      </section>

    </form>

    <h1>PCB Panelizer</h1>

    {% set pv = panelizer_values or {} %}
    {% set panelizer_set_options = [
      {"field": "include_set_A", "input": "SET_A", "label": "A: 1245 x 1041"},
      {"field": "include_set_B", "input": "SET_B", "label": "B: 1245 x 1092"},
      {"field": "include_set_C", "input": "SET_C", "label": "C: 1295 x 1092"},
      {"field": "include_set_D", "input": "SET_D", "label": "D: 1245 x 2082"},
      {"field": "include_set_E", "input": "SET_E", "label": "E: 1295 x 2184"},
    ] %}
    <form id="panelizer-form" method="get" novalidate>
      <section>
        <h2>Single PCB</h2>
        <div class="grid">
          <label>Single width (SPW, mm)
            <input type="number" step="0.1" name="SPW" id="SPW" value="{{ pv.single_pcb_width_max|default('', false) }}">
          </label>
          <label>Single length (SPL, mm)
            <input type="number" step="0.1" name="SPL" id="SPL" value="{{ pv.single_pcb_length_max|default('', false) }}">
          </label>
          <label>Allow rotate single
            <input type="checkbox" name="ARS" id="ARS" {% if pv.allow_rotate_single_pcb|default(false) %}checked{% endif %}>
          </label>
        </div>
      </section>

      <section>
        <h2>工作板</h2>
        <div class="grid">
          <label>Edge Width (EW_w, mm)
            <input type="number" step="0.1" name="EW_w" id="EW_w" value="{{ pv.panel_edge_margin_w|default('', false) }}">
          </label>
          <label>Edge Length (EW_l, mm)
            <input type="number" step="0.1" name="EW_l" id="EW_l" value="{{ pv.panel_edge_margin_l|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>大料</h2>
        <div class="grid">
          <label>Edge Width (BMW, mm)
            <input type="number" step="0.1" name="BMW" id="BMW" value="{{ pv.board_edge_margin_w|default('', false) }}">
          </label>
          <label>Edge Length (BML, mm)
            <input type="number" step="0.1" name="BML" id="BML" value="{{ pv.board_edge_margin_l|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>拼板</h2>
        <div class="grid">
          <label>Max Width (CBW, mm)
            <input type="number" step="0.1" name="CBW" id="CBW" value="{{ pv.customer_board_width_max|default('', false) }}">
          </label>
          <label>Max Length (CBL, mm)
            <input type="number" step="0.1" name="CBL" id="CBL" value="{{ pv.customer_board_length_max|default('', false) }}">
          </label>
          <label>Min Width (CBWM, mm)
            <input type="number" step="0.1" name="CBWM" id="CBWM" value="{{ pv.customer_board_width_min|default('', false) }}">
          </label>
          <label>Min Length (CBLM, mm)
            <input type="number" step="0.1" name="CBLM" id="CBLM" value="{{ pv.customer_board_length_min|default('', false) }}">
          </label>
          <label>Allow rotate board
            <input type="checkbox" name="ARB" id="ARB" {% if pv.allow_rotate_board|default(false) %}checked{% endif %}>
          </label>
        </div>
      </section>

      <section>
        <h2>Gaps</h2>
        <div class="grid">
          <label>拼板 gap W (CW, mm)
            <input type="number" step="0.1" name="CW" id="CW" value="{{ pv.inter_board_gap_w|default('', false) }}">
          </label>
          <label>拼板 gap L (CL, mm)
            <input type="number" step="0.1" name="CL" id="CL" value="{{ pv.inter_board_gap_l|default('', false) }}">
          </label>
          <label>单板 gap W (SW, mm)
            <input type="number" step="0.1" name="SW" id="SW" value="{{ pv.inter_single_gap_w|default('', false) }}">
          </label>
          <label>单板 gap L (SL, mm)
            <input type="number" step="0.1" name="SL" id="SL" value="{{ pv.inter_single_gap_l|default('', false) }}">
          </label>
          <label>Kerf （all gaps, mm)
            <input type="number" step="0.1" name="KERF" id="KERF" value="{{ pv.kerf_allowance|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>Panel Sets</h2>
        <div class="grid">
          {% for option in panelizer_set_options %}
          <label>{{ option.label }}
            <input type="checkbox" name="{{ option.input }}" id="{{ option.input }}" {% if pv.get(option.field) %}checked{% endif %}>
          </label>
          {% endfor %}
        </div>
      </section>

      <section class="form-controls">
        <h2>Display</h2>
        <div class="grid">
          <label>Max rows
            <input type="number" step="1" name="LIMIT" id="LIMIT" value="{{ pv.limit|default('', false) }}">
          </label>
        </div>
      </section>
    </form>

    <section id="panelizer-results" class="panelizer-results">
      {% if panelizer_error %}
      <p class="alert mono">{{ panelizer_error }}</p>
      {% endif %}
      {% if panelizer_summary %}

      <table class="panelizer-table" {% if not panelizer_summary.rows %}style="display:none"{% endif %}>
        <thead>
          <tr>
            <th class="l">Rank</th>
            <th>PCBs/Jumbo</th>
            <th>PCBs/Panel</th>
            <th>Panel WxL</th>
            <th>Board WxL</th>
            <th>Board size (mm)</th>
            <th>Panel style</th>
            <th>Panel size (mm)</th>
            <th>Utilization</th>
            <th>Rotation</th>
          </tr>
        </thead>
        <tbody>
          {% for row in panelizer_summary.rows %}
          {% set rotation = (('B' if row.board_rot else '') + ('S' if row.single_rot else '')) or '—' %}
          {% set star = ' ★' if panelizer_summary.max_pcbs_per_jumbo is not none and row.pcbs_per_jumbo == panelizer_summary.max_pcbs_per_jumbo else '' %}
          <tr>
            <td class="l">{{ loop.index }}{{ star }}</td>
            <td>{{ row.pcbs_per_jumbo }}</td>
            <td>{{ row.total_single_pcbs }}</td>
            <td>{{ row.nbw }}×{{ row.nbl }}</td>
            <td>{{ row.nw }}×{{ row.nl }}</td>
            <td>{{ "%.1f×%.1f"|format(row.board_w, row.board_l) }}</td>
            <td>{{ row.panel_style }}</td>
            <td>{{ "%.1f×%.1f"|format(row.panel_width, row.panel_length) }}</td>
            <td>{{ "%.2f%%"|format(row.utilization * 100) }}</td>
            <td>{{ rotation }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small" id="panelizer-results-message">{{ panelizer_summary.message }}</p>
      {% endif %}
    </section>
  </div>

  <aside class="page-summary">
    <section class="summary-card">
      <h2>Live Summary</h2>
      <div id="live-summary" class="grid">
        {% if result %}
        <ul class="mono">
          <li>Material: {{ result.breakdown.material.total }}
            <ul>
              <li>{{ values.material or 'Laminate' }}: {{ result.breakdown.material.components.laminate }}</li>
            </ul>
          </li>
          <li>Treatment: {{ result.breakdown.treatment.total }}
            <ul>
              <li>{{ values.finish or 'Finish' }}: {{ result.breakdown.treatment.components.finish }}</li>
              <li>线路: {{ result.breakdown.treatment.components.etching }}</li>
              <li>阻焊: {{ result.breakdown.treatment.components.masking }}</li>
              <li>文字丝印: {{ result.breakdown.treatment.components.silkscreen }}</li>
            </ul>
          </li>
          <li>CNC/panel: {{ result.breakdown.cnc.cnd_cost_panel }}
            <ul>
              <li>CNC Cost: {{ result.breakdown.cnc.components.cnc_pth }}</li>
            </ul>
          </li>
          <li>Process: {{ result.breakdown.process.total }}
            <ul>
              <li>电铜: {{ result.breakdown.process.components.plating }}</li>
              <li>开料: {{ result.breakdown.process.components.cutting }}</li>
              <li>锣板: {{ result.breakdown.process.components.routing }}</li>
              <li>啤板: {{ result.breakdown.process.components.stamping }}</li>
              <li>后工序: {{ result.breakdown.process.components.post_process }}</li>
            </ul>
          </li>
          <li>Sewage: {{ result.breakdown.sewage.total }}
            <ul>
              <li>污水: {{ result.breakdown.sewage.components.water }}</li>
              <li>电: {{ result.breakdown.sewage.components.electricity }}</li>
            </ul>
          </li>
          <li>Others: {{ result.breakdown.others.total }}
            <ul>
              <li>OH: {{ result.breakdown.others.overhead }}</li>
              <li>產出: {{ result.breakdown.others.yield }}</li>
            </ul>
          </li>
          <li>开料件数: {{ result.breakdown.boards_per_panel }}</li>
        </ul>
        <ul class="mono">
          <li>Panel Cost: {{ result.cogs }}</li>
          <li>Unit Cost: {{ result.cogs_unit }}</li>
          <li>Unit price: {{ result.price_unit }}</li>
        </ul>
        {% else %}
        <p class="summary-placeholder">Fill out the form to see pricing details here.</p>
        {% endif %}
      </div>
    </section>
  </aside>
</div>

<script id="priced-costs-data" type="application/json">{{ priced_costs|tojson }}</script>
<script id="priced-fields-config" type="application/json">{{ priced_client_config|tojson }}</script>
<script id="stack-qty-map" type="application/json">{{ stack_qty_map|tojson }}</script>

<script>
(function () {
  const costsDataEl = document.getElementById('priced-costs-data');
  const fieldsConfigEl = document.getElementById('priced-fields-config');
  const pricedCosts = costsDataEl ? JSON.parse(costsDataEl.textContent || '{}') : {};
  const pricedFields = fieldsConfigEl ? JSON.parse(fieldsConfigEl.textContent || '[]') : [];
  const stackQtyMapEl = document.getElementById('stack-qty-map');
  const stackQtyMap = stackQtyMapEl ? JSON.parse(stackQtyMapEl.textContent || '{}') : {};

  const form = document.getElementById('quote-form');
  const summary = document.getElementById('live-summary');
  if (!form || !summary) {
    return;
  }

  const fallbackFor = (name) => {
    const datasetKey = `default${name.charAt(0).toUpperCase()}${name.slice(1)}`;
    return form.dataset[datasetKey] || '';
  };

  const toDash = (value) => value.replace(/_/g, '-');

  let controller;

  const attachPriceField = ({ selectId, inputId, labelId, defaults, fallback }) => {
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    const label = document.getElementById(labelId);
    if (!select || !input || !label) {
      return;
    }

    const applyDefaults = (force = false) => {
      const selected = select.value || fallback;
      label.textContent = selected || fallback;
      if (!force && input.value) {
        return;
      }
      const base = defaults[selected];
      input.value = base === undefined ? '' : base;
    };

    select.addEventListener('change', () => applyDefaults(true));
    applyDefaults();
  };

  pricedFields.forEach(({ name, priceField }) => {
    const dashName = toDash(priceField);
    attachPriceField({
      selectId: `${name}-select`,
      inputId: `${dashName}-input`,
      labelId: `${dashName}-label`,
      defaults: pricedCosts[name] || {},
      fallback: fallbackFor(name),
    });
  });

  const submitForm = () => {
    const payload = new URLSearchParams(new FormData(form));

    if (controller) {
      controller.abort();
    }
    controller = new AbortController();

    fetch(form.action || window.location.pathname, {
      method: 'POST',
      body: payload,
      headers: { 'X-Requested-With': 'fetch' },
      signal: controller.signal,
    })
      .then((response) => response.text())
      .then((htmlText) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        const newSummary = doc.getElementById('live-summary');
        if (newSummary) {
          summary.innerHTML = newSummary.innerHTML;
        }
      })
      .catch((error) => {
        if (error.name === 'AbortError') {
          return;
        }
        console.error('Failed to refresh summary', error);
      });
  };

  const initStackQtySync = () => {
    const thicknessSelect = document.getElementById('pcb-thickness-select');
    const drillSelect = document.getElementById('cnc-hole-select');
    const stackQtyInput = document.getElementById('stack-qty-input');
    if (!thicknessSelect || !drillSelect || !stackQtyInput) {
      return;
    }
    const lookup = (thickness, drill) => {
      const byThickness = stackQtyMap[thickness];
      return byThickness ? byThickness[drill] : undefined;
    };
    const apply = () => {
      const derived = lookup(thicknessSelect.value, drillSelect.value);
      if (derived) {
        stackQtyInput.value = derived;
      }
    };
    thicknessSelect.addEventListener('change', apply);
    drillSelect.addEventListener('change', apply);
    apply();
  };

  initStackQtySync();

  const debouncedSubmit = (() => {
    let timeoutId;
    return () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(submitForm, 200);
    };
  })();

  form.addEventListener('input', debouncedSubmit);
  form.addEventListener('change', debouncedSubmit);
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    submitForm();
  });

  submitForm();
})();
</script>
<script>
(function () {
  const panelForm = document.getElementById('panelizer-form');
  if (!panelForm) {
    return;
  }
  let scheduled = false;
  const submit = () => {
    scheduled = false;
    if (typeof panelForm.requestSubmit === 'function') {
      panelForm.requestSubmit();
    } else {
      panelForm.submit();
    }
  };
  const queue = window.requestAnimationFrame || function (cb) { return setTimeout(cb, 0); };
  const schedule = () => {
    if (scheduled) {
      return;
    }
    scheduled = true;
    queue(submit);
  };
  panelForm.addEventListener('input', schedule);
  panelForm.addEventListener('change', schedule);
})();
</script>
</body>
</html>
