<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PCB Quote (Internal)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="/lt.png">
<link href="{{ url_for('static', filename='quote.css') }}" rel="stylesheet">
</head>
{% set panelizer_only = panelizer_only|default(false) %}
<body>

<div class="page-layout">
  <div class="page-main">
    {% if not panelizer_only %}
      {% if error_msgs and error_msgs|length %}
      <div class="alert">
        <ul>
          {% for m in error_msgs %}<li>{{ m }}</li>{% endfor %}
        </ul>
      </div>
      {% endif %}

      <form id="quote-form" method="post" novalidate data-default-material="{{ defaults.material|e }}" data-default-finish="{{ defaults.finish|e }}" data-default-masking="{{ defaults.masking|e }}" data-default-plating="{{ defaults.plating|e }}" data-default-substrate_thickness="{{ defaults.substrate_thickness|e }}" data-default-cu_thickness="{{ defaults.cu_thickness|e }}">
        <section>
          <h2>Materials</h2>
          <div class="grid">
            <label>板材
              <select name="material" id="material-select">
                {% for m in priced_options.material %}
                <option value="{{ m }}" {% if values.material==m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
              </select>
            </label>
            <label>基材厚度
              <select name="substrate_thickness" id="substrate-thickness-select">
                {% for option in substrate_thickness_options %}
                <option value="{{ option }}" {% if values.substrate_thickness==option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <label>铜厚度
              <select name="cu_thickness" id="cu-thickness-select">
                {% for option in cu_thickness_options %}
                <option value="{{ option }}" {% if values.cu_thickness==option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <label id="material-price-field">
              <span id="material-price-label">{{ (values.material or defaults.material) }}</span>
              <input name="material_price" id="material-price-input" type="number" step="1" value="{{ material_price_value }}">
            </label>
          </div>
        </section>

        <section>
          <h2>Layers</h2>
          <div class="grid">
            <label>层数
              <input name="layers" type="number" step="1" value="{{ values.layers }}">
            </label>
            <label>PP 层
              <input name="pp_cost" type="number" step="1" min="0" value="{{ values.pp_cost }}">
            </label>
            <label>内层
              <input name="inner_cost" type="number" step="1" min="0" value="{{ values.inner_cost }}">
            </label>
            <label>压合
              <input name="stacking_cost" type="number" step="1" min="0" value="{{ values.stacking_cost }}">
            </label>
          </div>
        </section>

        <section>
          <h2>Treatment</h2>
          <div class="grid">
            <label>表面处理
              <select name="finish" id="finish-select">
                {% for f in priced_options.finish %}
                <option value="{{ f }}" {% if values.finish==f %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
              </select>
            </label>
            <label id="finish-price-field">
              <span id="finish-price-label">{{ (values.finish or defaults.finish) }}</span>
              <input name="finish_price" id="finish-price-input" type="number" step="1" value="{{ finish_price_value }}">
            </label>
            <label>阻焊
              <select name="masking" id="masking-select">
                {% for mask in priced_options.masking %}
                <option value="{{ mask }}" {% if values.masking==mask %}selected{% endif %}>{{ mask }}</option>
                {% endfor %}
              </select>
            </label>
            <label id="masking-price-field">
              <span id="masking-price-label">{{ (values.masking or defaults.masking) }}</span>
              <input name="masking_price" id="masking-price-input" type="number" step="1" value="{{ masking_price_value }}">
            </label>
            <label>线路
              <input name="etching_cost" type="number" step="1" value="{{ values.etching_cost }}">
            </label>
            <label>文字丝印
              <input name="silkscreen_cost" type="number" step="1" value="{{ values.silkscreen_cost }}">
            </label>
          </div>
        </section>

        <section>
          <h2>CNC</h2>
          <div class="grid">
            <label>PCB厚度
              <select name="pcb_thickness" id="pcb-thickness-select">
                {% for t in pcb_thickness_options %}
                <option value="{{ t }}" {% if values.pcb_thickness==t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </label>
            <label>孔径
              <select name="cnc_hole_dimension" id="cnc-hole-select">
                {% for d in cnc_hole_dimension_options %}
                <option value="{{ d }}" {% if values.cnc_hole_dimension==d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </label>
            <label>每孔$$
              <input name="cnc_pth_per_hole" type="number" step="0.0001" min="0" value="{{ params_values.cnc_pth_per_hole }}">
            </label>
            <label>钻孔数
              <input name="cnc_pth_holes" type="number" step="1" min="0" value="{{ values.cnc_pth_holes }}">
            </label>
            <label>叠片数
              <input name="stack_qty" id="stack-qty-input" type="number" step="1" min="1" value="{{ values.stack_qty }}">
            </label>
          </div>
        </section>

        <section>
          <h2>Process</h2>
          <div class="grid">
            <label>电铜
              <select name="plating" id="plating-select">
                {% for p in priced_options.plating %}
                <option value="{{ p }}" {% if values.plating==p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
            </label>
            <label id="plating-price-field">
              <span id="plating-price-label">{{ (values.plating or defaults.plating) }}</span>
              <input name="plating_price" id="plating-price-input" type="number" step="1" value="{{ plating_price_value }}">
            </label>
            <label>每锣寸
              <input name="routing_per_inch" type="number" step="0.0001" min="0" value="{{ params_values.routing_per_inch }}">
            </label>
            <label>锣程 (寸)
              <input name="routing_length" type="number" step="1" min="0" value="{{ values.routing_length }}">
            </label>
            <label>啤板
              <input name="stamping_cost" type="number" step="1" min="0" value="{{ values.stamping_cost }}">
            </label>
            <label>后工序
              <input name="post_process_cost" type="number" step="1" min="0" value="{{ values.post_process_cost }}">
            </label>
          </div>
        </section>

        <section>
          <h2>Overhead</h2>
          <div class="grid">
            <label>污水
              <input name="sewage_water" type="number" step="1" value="{{ values.sewage_water }}">
            </label>
            <label>电
              <input name="sewage_electricity" type="number" step="1" value="{{ values.sewage_electricity }}">
            </label>
            <label>人工
              <input name="labor_cost" type="number" step="1" min="0" value="{{ params_values.labor_cost }}">
            </label>
          </div>
        </section>

        <section>
          <h2>Others</h2>
          <div class="grid">
            <label>开料件数
              <input name="panel_boards" type="number" step="1" value="{{ values.panel_boards }}">
            </label>
            <label>损耗 (%)
              <input name="loss_pct" type="number" step="0.1" min="0" max="100" value="{{ params_values.loss_pct }}">
            </label>
            <label>利润 (%)
              <input name="margin_pct" type="number" step="0.5" min="0" value="{{ params_values.margin_pct }}">
            </label>
          </div>
        </section>

      </form>
      <hr>
    {% endif %}
    {% set pv = panelizer_values or {} %}
    {% set panelizer_set_options = [
      {"field": "include_set_A", "input": "SET_A", "label": "A: 1245 x 1041"},
      {"field": "include_set_B", "input": "SET_B", "label": "B: 1245 x 1092"},
      {"field": "include_set_C", "input": "SET_C", "label": "C: 1295 x 1092"},
      {"field": "include_set_D", "input": "SET_D", "label": "D: 1245 x 2082"},
      {"field": "include_set_E", "input": "SET_E", "label": "E: 1295 x 2184"},
    ] %}
    <form id="panelizer-form" method="post" novalidate {% if panelizer_only %}action="{{ url_for('panelizer_only') }}"{% endif %}>

      <section>
        <h2>大料规格</h2>
        <div class="grid">
          {% for option in panelizer_set_options %}
          <label>{{ option.label }}
            <input type="checkbox" name="{{ option.input }}" id="{{ option.input }}" {% if pv.get(option.field) %}checked{% endif %}>
          </label>
          {% endfor %}
        </div>
      </section>
      
      <section>
        <h2>单板尺寸</h2>
        <div class="grid">
          <label>Width (SPW)
            <input type="number" step="0.01" name="SPW" id="SPW" value="{{ pv.single_pcb_width_max|default('', false) }}">
          </label>
          <label>Length (SPL)
            <input type="number" step="0.01" name="SPL" id="SPL" value="{{ pv.single_pcb_length_max|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>工作板边</h2>
        <div class="grid">
          <label>Width (PEW)
            <input type="number" step="0.2" name="PEW" id="PEW" value="{{ pv.panel_edge_margin_w|default('', false) }}">
          </label>
          <label>Length (PEL)
            <input type="number" step="0.2" name="PEL" id="PEL" value="{{ pv.panel_edge_margin_l|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>连片板边</h2>
        <div class="grid">
          <label>Width (BMW)
            <input type="number" step="0.2" name="BMW" id="BMW" value="{{ pv.board_edge_margin_w|default('', false) }}">
          </label>
          <label>Length (BML)
            <input type="number" step="0.2" name="BML" id="BML" value="{{ pv.board_edge_margin_l|default('', false) }}">
          </label>
        </div>
      </section>

      <section>
        <h2>拼板</h2>
        <div class="grid">
          <label>Max W (CBW)
            <input type="number" step="1" name="CBW" id="CBW" value="{{ pv.customer_board_width_max|default('', false) }}">
          </label>
          <label>Max L (CBL)
            <input type="number" step="1" name="CBL" id="CBL" value="{{ pv.customer_board_length_max|default('', false) }}">
          </label>
          <label>Min W (CBWM)
            <input type="number" step="1" name="CBWM" id="CBWM" value="{{ pv.customer_board_width_min|default('', false) }}">
          </label>
          <label>Min L (CBLM)
            <input type="number" step="1" name="CBLM" id="CBLM" value="{{ pv.customer_board_length_min|default('', false) }}">
          </label>

        </div>
      </section>

      <section>
        <h2>间隔</h2>
        <div class="grid">
          <label>拼板 W (CW)
            <input type="number" step="0.2" name="CW" id="CW" value="{{ pv.inter_board_gap_w|default('', false) }}">
          </label>
          <label>拼板 L (CL)
            <input type="number" step="0.2" name="CL" id="CL" value="{{ pv.inter_board_gap_l|default('', false) }}">
          </label>
          <label>单板 W (SW)
            <input type="number" step="0.2" name="SW" id="SW" value="{{ pv.inter_single_gap_w|default('', false) }}">
          </label>
          <label>单板 L (SL)
            <input type="number" step="0.2" name="SL" id="SL" value="{{ pv.inter_single_gap_l|default('', false) }}">
          </label>
        </div>
      </section>

      <section class="form-controls">
        <h2>Display</h2>
        <div class="grid">
          <label>Max rows
            <input type="number" step="1" name="LIMIT" id="LIMIT" value="{{ pv.limit|default('', false) }}">
          </label>
          <label>单板旋转
            <input type="checkbox" name="ARS" id="ARS" {% if pv.allow_rotate_single_pcb|default(false) %}checked{% endif %}>
          </label>
          <label>拼板旋转
            <input type="checkbox" name="ARB" id="ARB" {% if pv.allow_rotate_board|default(false) %}checked{% endif %}>
          </label>
        </div>
      </section>
    </form>

    <section id="panelizer-results" class="panelizer-results results">
      {% if panelizer_error %}
      <p class="alert mono">{{ panelizer_error }}</p>
      {% endif %}
      {% if panelizer_summary %}

      <table id="results-table" class="panelizer-table" {{ panelizer_summary.table_attrs|safe }}>
        <thead>
          <tr>
            <th class="l">Rank</th>
            <th>PCBs/Jumbo</th>
            <th>PCBs/Panel</th>
            <th>Panel WxL</th>
            <th>Board WxL</th>
            <th>Board size (mm)</th>
            <th>Panel style</th>
            <th>Panel size (mm)</th>
            <th>Utilization</th>
            <th>Rotation</th>
          </tr>
        </thead>
        <tbody>
          {% for row in panelizer_summary.rows %}
          {% set rotation = (('B' if row.board_rot else '') + ('S' if row.single_rot else '')) or '—' %}
          {% set star = ' ★' if panelizer_summary.max_pcbs_per_jumbo is not none and row.pcbs_per_jumbo == panelizer_summary.max_pcbs_per_jumbo else '' %}
          <tr>
            <td class="l">{{ loop.index }}{{ star }}</td>
            <td>{{ row.pcbs_per_jumbo }}</td>
            <td>{{ row.total_single_pcbs }}</td>
            <td>{{ row.nbw }}×{{ row.nbl }}</td>
            <td>{{ row.nw }}×{{ row.nl }}</td>
            <td>{{ "%.1f×%.1f"|format(row.board_w, row.board_l) }}</td>
            <td>{{ row.panel_style }}</td>
            <td>{{ "%.1f×%.1f"|format(row.panel_width, row.panel_length) }}</td>
            <td>{{ "%.2f%%"|format(row.utilization * 100) }}</td>
            <td>{{ rotation }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="small" id="panelizer-results-message">{{ panelizer_summary.message }}</p>
      {% endif %}
    </section>
  </div>

  {% if not panelizer_only %}
  <aside class="page-summary">
    <section class="summary-card">
      <h2>Live Summary</h2>
      <div id="live-summary" class="grid">
        {% if result %}
        <ul class="mono">
          <li>Material: {{ result.breakdown.material.total }}
            <ul>
              <li>{{ values.material or 'Laminate' }}: {{ result.breakdown.material.components.laminate }}</li>
            </ul>
          </li>
          <li>Layers: {{ result.breakdown.multi_layer.total }}
            <ul>
              <li>PP 层: {{ result.breakdown.multi_layer.components.pp_cost }}</li>
              <li>内层: {{ result.breakdown.multi_layer.components.inner_cost }}</li>
              <li>压合: {{ result.breakdown.multi_layer.components.stacking_cost }}</li>
            </ul>
          </li>
          <li>Treatment: {{ result.breakdown.treatment.total }}
            <ul>
              <li>{{ values.finish or 'Finish' }}: {{ result.breakdown.treatment.components.finish }}</li>
              <li>线路: {{ result.breakdown.treatment.components.etching }}</li>
              <li>阻焊: {{ result.breakdown.treatment.components.masking }}</li>
              <li>文字丝印: {{ result.breakdown.treatment.components.silkscreen }}</li>
            </ul>
          </li>
          <li>CNC/panel: {{ result.breakdown.cnc.cnd_cost_panel }}
            <ul>
              <li>CNC Cost: {{ result.breakdown.cnc.components.cnc_pth }}</li>
            </ul>
          </li>
          <li>Process: {{ result.breakdown.process.total }}
            <ul>
              <li>电铜: {{ result.breakdown.process.components.plating }}</li>
              <li>锣板: {{ result.breakdown.process.components.routing }}</li>
              <li>啤板: {{ result.breakdown.process.components.stamping }}</li>
              <li>后工序: {{ result.breakdown.process.components.post_process }}</li>
            </ul>
          </li>
          <li>Overhead: {{ result.breakdown.overhead.total }}
            <ul>
              <li>污水: {{ result.breakdown.overhead.components.water }}</li>
              <li>电: {{ result.breakdown.overhead.components.electricity }}</li>
              <li>人工: {{ result.breakdown.overhead.components.labor }}</li>
            </ul>
          </li>
          <li>Others: {{ result.breakdown.others.total }}
            <ul>
              <li>损耗: {{ result.breakdown.others.loss }}</li>
              <li>利润: {{ result.breakdown.others.margin }}</li>
            </ul>
          </li>
        </ul>
        <ul class="mono">
          <li>Panel Cost: {{ result.cogs }}</li>
          <li>开料件数: {{ result.breakdown.boards_per_panel }}</li>
          <li>Unit Cost: {{ result.cogs_unit }}</li>
          <li>Unit price: {{ result.price_unit }}</li>
        </ul>
        {% else %}
        <p class="summary-placeholder">Fill out the form to see pricing details here.</p>
        {% endif %}
      </div>
    </section>
  </aside>
  {% endif %}
</div>

{% if not panelizer_only %}
<script id="priced-costs-data" type="application/json">{{ priced_costs|tojson }}</script>
<script id="priced-fields-config" type="application/json">{{ priced_client_config|tojson }}</script>
<script id="stack-qty-map" type="application/json">{{ stack_qty_map|tojson }}</script>
{% endif %}

<script>
(function () {
  const quoteForm = document.getElementById('quote-form');
  const panelForm = document.getElementById('panelizer-form');
  const liveSummary = document.getElementById('live-summary');
  const panelizerResults = document.getElementById('panelizer-results');

  const parseJSON = (id, fallback) => {
    const element = document.getElementById(id);
    if (!element) return fallback;
    try {
      const parsed = JSON.parse(element.textContent || 'null');
      return parsed == null ? fallback : parsed;
    } catch (error) {
      console.error(`Failed to parse ${id}`, error);
      return fallback;
    }
  };

  const pricedCosts = parseJSON('priced-costs-data', {});
  const pricedFields = parseJSON('priced-fields-config', []);
  const stackQtyMap = parseJSON('stack-qty-map', {});
  if (!quoteForm && !panelForm) return;

  let controller;

  const updateDOM = (htmlText) => {
    const doc = new DOMParser().parseFromString(htmlText, 'text/html');
    if (liveSummary) {
      const newSummary = doc.getElementById('live-summary');
      if (newSummary) liveSummary.innerHTML = newSummary.innerHTML;
    }
    if (panelizerResults) {
      const newResults = doc.getElementById('panelizer-results');
      if (newResults) panelizerResults.innerHTML = newResults.innerHTML;
    }
    if (quoteForm) {
      const panelBoardsInput = quoteForm.querySelector('input[name="panel_boards"]');
      const newPanelBoardsInput = doc.querySelector('#quote-form input[name="panel_boards"]');
      if (panelBoardsInput && newPanelBoardsInput) {
        panelBoardsInput.value = newPanelBoardsInput.value;
      }
    }
  };

  const submitForm = () => {
    const targetForm = quoteForm || panelForm;
    if (!targetForm) return;

    const formData = new FormData(targetForm);
    if (quoteForm && panelForm) {
      new FormData(panelForm).forEach((value, key) => formData.set(key, value));
    }

    if (controller) controller.abort();
    controller = new AbortController();

    fetch(targetForm.action || window.location.pathname, {
      method: 'POST',
      body: new URLSearchParams(formData),
      headers: { 'X-Requested-With': 'fetch' },
      signal: controller.signal,
    })
      .then((response) => response.text())
      .then(updateDOM)
      .catch((error) => {
        if (error.name !== 'AbortError') console.error('Fetch failed', error);
      });
  };

  const debouncedSubmit = (() => {
    let timer;
    return () => {
      clearTimeout(timer);
      timer = setTimeout(submitForm, 200);
    };
  })();

  [quoteForm, panelForm].filter(Boolean).forEach((formElement) => {
    formElement.addEventListener('input', debouncedSubmit);
    formElement.addEventListener('change', debouncedSubmit);
    formElement.addEventListener('submit', (event) => {
      event.preventDefault();
      submitForm();
    });
  });

  if (quoteForm) {
    const toDash = (s) => s.replace(/_/g, '-');
    const getDefault = (name) =>
      quoteForm.dataset[`default${name[0].toUpperCase()}${name.slice(1)}`] || '';
    const getId = (base) => document.getElementById(base);
    const substrateSel = getId('substrate-thickness-select');
    const cuSel = getId('cu-thickness-select');
    const defaultSubstrate = getDefault('substrate_thickness');
    const defaultCu = getDefault('cu_thickness');
    let materialFieldSync;

    pricedFields.forEach(({ name, priceField }) => {
      const sel = getId(`${name}-select`);
      const inp = getId(toDash(priceField) + '-input');
      const lbl = getId(toDash(priceField) + '-label');
      if (!sel || !inp || !lbl) return;

      const isMaterialField = name === 'material';
      const sync = (force) => {
        const val = sel.value || getDefault(name);
        lbl.textContent = val;
        if (force || !inp.value) {
          let priceValue = pricedCosts[name]?.[val];
          if (isMaterialField) {
            const substrate = substrateSel?.value || defaultSubstrate;
            const cu = cuSel?.value || defaultCu;
            priceValue = pricedCosts[name]?.[val]?.[substrate]?.[cu];
          }
          inp.value = priceValue ?? '';
        }
      };

      sel.addEventListener('change', () => sync(true));
      sync();

      if (isMaterialField) {
        materialFieldSync = sync;
      }
    });

    if (materialFieldSync) {
      [substrateSel, cuSel].filter(Boolean).forEach((select) => {
        select.addEventListener('change', () => materialFieldSync(true));
      });
    }

    const thickSel = getId('pcb-thickness-select');
    const holesSel = getId('cnc-hole-select');
    const stackInp = getId('stack-qty-input');
    if (thickSel && holesSel && stackInp) {
      const updateStack = () => {
        const derived = stackQtyMap[thickSel.value]?.[holesSel.value];
        if (derived) stackInp.value = derived;
      };
      thickSel.addEventListener('change', updateStack);
      holesSel.addEventListener('change', updateStack);
      updateStack();
    }
  }

  submitForm();
})();
</script>
</body>
</html>
